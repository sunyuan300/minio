# AWS签名类型
## 什么是AWS签名
与S3的每次交互必须经过身份认证或匿名,签名能够提供以下部分或全部功能。
- 验证请求者的身份
- 防止数据被篡改

## AWS V2 和 AWS V4签名
V2是早期的签名方式，签名过程简单，已被弃用。V4是最新的签名算法，签名过程比较复杂。

# 身份验证方法
- HTTP授权头：使用HTTP`Authorization`头部进行验证。
- Query请求参数：通过在URL中提供身份验证信息。由于签名是URL的一部分，因此被称为预签名URL。

# AWS V2签名过程
```
Authorization: AWS AWSAccessKeyId:Signature
```

```
Authorization = "AWS" + " " + AWSAccessKeyId + ":" + Signature;

Signature = Base64( HMAC-SHA1( UTF-8-Encoding-Of(YourSecretAccessKey), UTF-8-Encoding-Of( StringToSign ) ) );

StringToSign = HTTP-Verb + "\n" +
	Content-MD5 + "\n" +
	Content-Type + "\n" +
	Date + "\n" +
	CanonicalizedAmzHeaders +
	CanonicalizedResource;

CanonicalizedResource = [ "/" + Bucket ] +
	<HTTP-Request-URI, from the protocol name up to the query string> +
	[ subresource, if present. For example "?acl", "?location", or "?logging"];

CanonicalizedAmzHeaders = <described below>
```
[AWS Signature Version 2](https://docs.aws.amazon.com/zh_cn/AmazonS3/latest/userguide/RESTAuthentication.html#ConstructingTheAuthenticationHeader)

# AWS V4签名过程
![](AWS4%20签名.png)

## 一、创建规范请求
```markdown
CanonicalRequest =
HTTPRequestMethod + '\n' +
CanonicalURI + '\n' +
CanonicalQueryString + '\n' +
CanonicalHeaders + '\n' +
SignedHeaders + '\n' +
HexEncode(Hash(RequestPayload))
```
- CanonicalURI：编码后的URI。
- CanonicalQueryString：按照ASCII码排序后的参数名和值。
- CanonicalHeaders：处理后的header(统一小写、移除多余的空格、排序)。
- SignedHeaders：参与签名的header字段，用分号`;`连接形成字符串。
- Hex(Hash(RequestPayload))：对body进行hash操作(可选)。

最后将拼接而成的字符串进行sha256哈希，得到一个hash值。
## 二、创建待签名字符串
```markdown
StringToSign =
Algorithm + \n +
RequestDateTime + \n +
CredentialScope + \n +
HashedCanonicalRequest
```
- Algorithm：用于创建规范请求的哈希的算法。对于 SHA-256，算法是 AWS4-HMAC-SHA256。
- RequestDateTime：在凭证范围内使用的日期和时间。该值是采用ISO8601格式的当前UTC时间（例如 20130524T000000Z）。
- CredentialScope：凭证范围。将生成的签名限制在指定的区域和服务范围内。该字符串采用以下格式：YYYYMMDD/region/service/aws4_request。
- HashedCanonicalRequest：规范请求的哈希。
## 三、计算签名
```markdown
DateKey = HMAC-SHA256("AWS4"+"<SecretAccessKey>", "<YYYYMMDD>")
DateRegionKey = HMAC-SHA256(<DateKey>, "<aws-region>")
DateRegionServiceKey = HMAC-SHA256(<DateRegionKey>, "<aws-service>")
SigningKey = HMAC-SHA256(<DateRegionServiceKey>, "aws4_request")
```
之后将SigningKey与第二步的待签名字符串进行hash，计算出最终的签名并转换成16机制。
```markdown
signature = HexEncode(HMAC-SHA256(signKey, string to sign))
```
最后添加上http头部Authorization即可：
```markdown
Authorization: algorithm Credential=access key ID/credential scope, SignedHeaders=SignedHeaders, Signature=signature
eg:
Authorization: AWS4-HMAC-SHA256 Credential=AKIDEXAMPLE/20150830/us-east-1/iam/aws4_request, SignedHeaders=content-type;host;x-amz-date, Signature=5d672d79c15b13162d9279b0855cfba6789a8edb4c82c400e06b5924a6f2b5d7
```
### Reference
[创建已签名的 AWS API 请求](https://docs.aws.amazon.com/zh_cn/IAM/latest/UserGuide/create-signed-request.html)

[S3对象存储AWS4签名分析与实现](https://www.dovefi.com/post/s3%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8aws4%E7%AD%BE%E5%90%8D%E5%88%86%E6%9E%90%E4%B8%8E%E5%AE%9E%E7%8E%B0/)
